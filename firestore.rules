
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper to check if user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper to check if user owns the record
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Profiles: Any authenticated user can read profiles (needed for mentions/lookups),
    // but only the owner or an admin can write.
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isOwner(userId) || (isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // Maintenance Requests: Tenants can read/write their own, admins/agents can manage all.
    match /maintenanceRequests/{requestId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // Notices to Vacate: Access for authenticated residents and management.
    match /noticesToVacate/{noticeId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // Properties and Units: Read access for all staff/owners, write for admin/agent.
    match /properties/{propertyId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // Tenants: Read access for all staff, write for admin/agent.
    match /tenants/{tenantId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // Payments: Read for relevant parties, write for admin/accounts.
    match /payments/{paymentId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // Catch-all for other collections defined in the schema
    match /{document=**} {
      allow read, write: if isSignedIn();
    }
  }
}
